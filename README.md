`–≠—Ç–æ—Ç —Ñ–∞–π–ª README –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –¥–≤—É—Ö —è–∑—ã–∫–∞—Ö: RU –∏ EN.`
# 1. Leadinc AI Assistant ‚Äî —Å–µ—Ä–≤–µ—Ä —É–º–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ –¥–ª—è B2B-–ø—Ä–æ–¥–∞–∂
<img width="2559" height="1238" alt="image_2025-09-12_13-02-56" src="https://github.com/user-attachments/assets/b75b51a7-7610-464b-880d-0ddcce7102ee" />

**–î–ª—è –±–∏–∑–Ω–µ—Å–∞: –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–æ–¥–∞–≤–∞—Ç—å –±—ã—Å—Ç—Ä–µ–µ –∏ —Ç–æ—á–Ω–µ–µ. –û–Ω –∫–∞–∫ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä:**

- –ø–æ–¥—Å–∫–∞–∂–µ—Ç, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–µ—Ä–≤–∏—Å –∏ —Å —á–µ–≥–æ –Ω–∞—á–∞—Ç—å;

- –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç –Ω–∞ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –ø–æ —É—Å–ª—É–≥–∞–º;

- –ø—Ä–æ–≤–µ–¥—ë—Ç –±—ã—Å—Ç—Ä—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é;

- –≤—ã–¥–∞—Å—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ 1 –∏–∑ 430 –±–∏–∑–Ω–µ—Å-–Ω–∏—à;

- —Å–Ω–∏–∂–∞–µ—Ç –≤—Ä–µ–º—è –Ω–∞ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è, –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è ‚Üí –∫–æ–º–∞–Ω–¥–∞ –º–µ–Ω—å—à–µ –æ—Ç–≤–ª–µ–∫–∞–µ—Ç—Å—è, –ª–∏–¥—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ, –º–µ–Ω—å—à–µ ¬´—É—Ç–µ—á–µ–∫¬ª –Ω–∞ —ç—Ç–∞–ø–∞—Ö –≤–æ—Ä–æ–Ω–∫–∏.

# 2. üß≠ TL;DR

- –ß—Ç–æ —ç—Ç–æ: FastAPI-–±—ç–∫–µ–Ω–¥ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ Leadinc —Å RAG (2 –∫–æ–ª–ª–µ–∫—Ü–∏–∏: FAQ/Analytics), –≥–æ–ª–æ—Å–æ–º (STT/TTS), Redis-–ª–∏–º–∏—Ç–∞–º–∏, –¥–∞–Ω–Ω—ã–º–∏ –≤ Postgres, –≤–µ–∫—Ç–æ—Ä–Ω—ã–º –ø–æ–∏—Å–∫–æ–º ChromaDB –∏ Celery –≤–æ—Ä–∫–µ—Ä–∞–º–∏.

- –ó–∞—á–µ–º –±–∏–∑–Ω–µ—Å—É: –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–∞–∫ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä ‚Äî –±—ã—Å—Ç—Ä–æ –æ–±—ä—è—Å–Ω—è–µ—Ç –ø—Ä–æ–¥—É–∫—Ç, –≤–µ–¥—ë—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é, –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ FAQ, –æ—Ç–¥–∞—ë—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ 1 –∏–∑ 430+ –Ω–∏—à ‚Üí –º–µ–Ω—å—à–µ —Ä—É—Ç–∏–Ω—ã —É –∫–æ–º–∞–Ω–¥—ã, –±—ã—Å—Ç—Ä–µ–µ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∏–¥–æ–≤, –Ω–∏–∂–µ –ø–æ—Ç–µ—Ä–∏ –ø–æ –≤–æ—Ä–æ–Ω–∫–µ.

- –°—Ü–µ–Ω–∞—Ä–∏–∏ LLM: REGISTRATION, FAQ, ANALYTICS, OFFTOPIC. –ù–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å ‚Äî —Ä–æ–≤–Ω–æ –æ–¥–Ω–∞ RAG-–∫–æ–ª–ª–µ–∫—Ü–∏—è (–±–µ–∑ —Å–º–µ—à–∏–≤–∞–Ω–∏—è).

- –ó–∞–ø—É—Å–∫: –ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ venv (Docker –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏).

- RAG-–¥–∞–Ω–Ω—ã–µ: –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ (–≤ –ø—É–±–ª–∏—á–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –≤—Ö–æ–¥—è—Ç).

- –°—Ç–∞—Ç—É—Å: ALPHA —Ç–µ—Å—Ç (—Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π HTTPS –¥–ª—è —Ç–µ—Å—Ç–æ–≤).

- –ö—É–¥–∞ —Å–º–æ—Ç—Ä–µ—Ç—å: ‚öôÔ∏è –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç ‚Üí üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Üí üß© –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ ‚Üí üéØ –°—Ü–µ–Ω–∞—Ä–∏–∏.

# 3 ‚öôÔ∏è –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
**1) –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**
git clone https://github.com/Kentokpro/gpt-assistant.git
cd ai-assistant

**2) Python venv**
source ~/ai-assistant/backend/venv/bin/activate

**3) –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**
pip install -r ai-assistant/backend/requirements.txt

**4) –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**
–°–æ–∑–¥–∞–π ai-assistant/backend/.env.backend.

**5) –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –º–∏–≥—Ä–∞—Ü–∏–∏**
alembic upgrade head

**6) (–ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è) –∑–∞–ø—É—Å—Ç–∏ ChromaDB –æ—Ç–¥–µ–ª—å–Ω–æ (–≤–µ—Ä—Å–∏—é –∏–∑ requirements.txt)**
–ø—Ä–∏–º–µ—Ä: chroma run --host 000.0.0.0 --port 0000

**7) –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**
uvicorn backend.main:app --host 0.0.0.0 --port 0000 --reload

**8) –¢–µ—Å—Ç–æ–≤—ã–π —Ñ—Ä–æ–Ω—Ç**
–û—Ç–∫—Ä–æ–π –≤ –±—Ä–∞—É–∑–µ—Ä–µ frontend_test/index.html (–ª–æ–∫–∞–ª—å–Ω–æ) –∏ –ø—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API.

# 4. üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:
<img width="1455" height="1147" alt="image_2025-09-12_13-17-12" src="https://github.com/user-attachments/assets/a24d0dcf-b8bd-40a5-af2a-5643d7883ad1" />
<img width="1455" height="635" alt="image_2025-09-12_13-17-44" src="https://github.com/user-attachments/assets/5f9a7bc0-e6fa-4cd4-aa40-3870cff44e27" />

# 5. üß© –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –∫–ª—é—á–µ–≤–∞—è –ª–æ–≥–∏–∫–∞
**–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (ALPHA):**
- **OS:** Ubuntu 22.04.5 LTS (jammy), Python 3.10.12
- **Reverse-proxy:** Nginx (443/HTTPS; —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –¥–ª—è —Ç–µ—Å—Ç–æ–≤)
- **Backend:** FastAPI (Uvicorn) ‚Äî `gpt-backend.service` –Ω–∞ `000.0.0.0:0000`
- **DB:** PostgreSQL 14 (0000)
- **Cache/Rate-limit/State:** Redis 6.0.16 (0000)
- **Vector DB:** ChromaDB (HTTP 0000) ‚Äî `leadinc-chroma.service`
- **Queues:** Celery ‚Äî 2 –≤–æ—Ä–∫–µ—Ä–∞ `text`, 2 –≤–æ—Ä–∫–µ—Ä–∞ `audio` (—Ä–∞–∑–¥–µ–ª—å–Ω—ã–µ –æ—á–µ—Ä–µ–¥–∏)
- **Codes:** `code-service` (0000) ‚Äî –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ 6-–∑–Ω–∞—á–Ω—ã–µ –∫–æ–¥—ã (TTL 10 –º–∏–Ω)
- **Static test front:** `/var/www/leadinc/static/chat.html`

**–¢–µ—Å—Ç–æ–≤—ã–π Front (HTML+JS):**
- POST /ai/chat (—Ç–µ–∫—Å—Ç ‚Üí —Ç–µ–∫—Å—Ç/–≥–æ–ª–æ—Å),
- POST /ai/voice_upload (—Ñ–∞–π–ª ‚Üí STT),
- POST /ai/tts (—Ç–µ–∫—Å—Ç ‚Üí –∞—É–¥–∏–æ).
–¢—Ä–µ–±—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ CORS (—Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–π origin) –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ cookie –≤ –±—Ä–∞—É–∑–µ—Ä–µ (—Å–º. SECURE_COOKIES/SameSite).

**–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤: –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –≤—ã–±–∏—Ä–∞–µ—Ç –æ–¥–∏–Ω –∏–∑ 4 —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤. –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ –æ–¥–Ω–æ–π RAG-–∫–æ–ª–ª–µ–∫—Ü–∏–∏.**
**–°—Ü–µ–Ω–∞—Ä–∏–∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞:**
- **FAQ** ‚Üí –∫–æ–ª–ª–µ–∫—Ü–∏—è `faq_leadinc` (RAG)
- **ANALYTICS** ‚Üí –∫–æ–ª–ª–µ–∫—Ü–∏—è `analytics_leadinc` (RAG)
- **REGISTRATION** ‚Üí —Å—Ç–∞–¥–∏–π–Ω–∞—è –≤–æ—Ä–æ–Ω–∫–∞ 1‚Üí3, –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ –∫–æ–¥—ã (code-service), –º–∏–≥—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ `user_id`
- **OFFTOPIC** ‚Üí –±–æ–ª—Ç–∞–ª–∫–∞ —Å –ª–∏–º–∏—Ç–∞–º–∏

> –ù–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—Ä–æ–≤–Ω–æ –æ–¥–Ω–∞** RAG-–∫–æ–ª–ª–µ–∫—Ü–∏—è (FAQ **–∏–ª–∏** Analytics), –±–µ–∑ —Å–º–µ—à–∏–≤–∞–Ω–∏—è.

Stage-–ª–æ–≥–∏–∫–∞: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≥–æ—Å—Ç—å (1‚Äì2) ‚Üí —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Üí –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π (3).

–ì–æ–ª–æ—Å: –∑–∞–≥—Ä—É–∑–∫–∞ ‚Üí STT ‚Üí –æ—Ç–≤–µ—Ç + –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π TTS (—Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –∞–≤—Ç–æ–æ—á–∏—â–∞–µ—Ç—Å—è).

# 6. üéØ –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

**–¶–µ–Ω–Ω–æ—Å—Ç—å: –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç, –º–µ–Ω—å—à–µ –≤–æ–ø—Ä–æ—Å–æ–≤ ¬´–∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç¬ª, –≥–æ—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –Ω–∏—à–µ ‚Äî –±—ã—Å—Ç—Ä–µ–µ –∫ –ø—Ä–æ–¥–∞–∂–∞–º.**

**REGISTRATION** - –í–æ—Ä–æ–Ω–∫–∞ —Å—Ç–∞–¥–∏–π (1‚Üí3): –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ‚Üí –≥–æ—Ä–æ–¥/–Ω–∏—à–∞ ‚Üí –∞–≤—Ç–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è. –°–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–≤—è–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é, –≤—ã–¥–∞—ë—Ç JWT, –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–µ—Ä–µ–π—Ç–∏ –∫ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ.

**FAQ** - –û—Ç–≤–µ—Ç—ã –ø–æ —Å–µ—Ä–≤–∏—Å—É (–∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç, —É—Å–ª–æ–≤–∏—è, –∑–∞–ø—É—Å–∫, —á—Ç–æ –≤—Ö–æ–¥–∏—Ç). –ò—Å—Ç–æ—á–Ω–∏–∫ ‚Äî –∫–æ–ª–ª–µ–∫—Ü–∏—è faq_leadinc (RAG).

**ANALYTICS** - –í—ã–¥–∞—ë—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –Ω–∏—à–µ –∏–∑ analytics_leadinc (RAG).

**OFFTOPIC** - –ü—Ä–æ—Å—Ç–æ –ø–æ–±–æ–ª—Ç–∞—Ç—å, –Ω–µ–Ω–∞–≤—è–∑—á–∏–≤–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –∫ —Ü–µ–ª–∏ (–ª–∏–º–∏—Ç—ã –∏ –∞–Ω—Ç–∏—Ñ–ª—É–¥ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ).

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏:**
- –ì–∏–±—Ä–∏–¥–Ω—ã–π RAG: ChromaDB, 2 –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (FAQ/Analytics), –∑–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–∏—à –∫—ç—à–∏—Ä—É—é—Ç—Å—è.
- Auth/–ª–∏–º–∏—Ç—ã: JWT-cookie, –æ—Ç–¥–µ–ª—å–Ω–∞—è session-cookie, —Å—Ç–∞–¥–∏–∏/–∫–≤–æ—Ç—ã –∏ –∞–Ω—Ç–∏—Ñ–ª—É–¥ –Ω–∞ Redis. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ (whitelist e-mail ‚Äî –±–∞–π–ø–∞—Å).
- Voice: STT (Whisper) –∏ TTS (ElevenLabs), –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –ø–æ —Ç–∞–π–º–µ—Ä—É.
- –¢–µ—Å—Ç-—Ñ—Ä–æ–Ω—Ç: —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ API (–±–µ–∑ –ø—Ä–æ–¥-—Ñ—É–Ω–∫—Ü–∏–π).

# 7. üîê **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ø—Ä–∏–º–µ—Ä backend/.env.backend)**
**JWT –∏ –æ–±—â–∏–µ —Å–µ–∫—Ä–µ—Ç—ã**
SECRET=(secret)

SECRET_ADMIN_TOKEN=(secret)

OPENAI_API_KEY=(secret)

ELEVENLABS_API_KEY=(secret)

**–û—Å–Ω–æ–≤–Ω–æ–π –≥–æ–ª–æ—Å**

ELEVENLABS_VOICE_ID=(secret)

**–†–µ–∑–µ—Ä–≤–Ω—ã–π –≥–æ–ª–æ—Å –Ω–∞ –ø–æ–¥–º–µ–Ω—É –æ—Å–Ω–æ–≤–Ω–æ–≥–æ**

ELEVENLABS_FALLBACK_VOICE_ID=(secret)

**Redis**

REDIS_URL=redis://localhost:0000

**Postgres connection**
DATABASE_URL=postgresql+asyncpg://(—Å–µ–∫—Ä–µ—Ç):(—Å–µ–∫—Ä–µ—Ç)@000.0.0.0:(–ø–æ—Ä—Ç)/(database_name)

POSTGRES_USER=(user_name)

POSTGRES_PASSWORD=(secret)

POSTGRES_DB=(database_name)

POSTGRES_HOST=000.0.0.0

POSTGRES_PORT=(port)

**ChromaDB (RAG)**

CHROMA_HOST=localhost

CHROMA_PORT=0000

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å–µ—Å—Å–∏–∏**

SECURE_COOKIES=false

CSRF_ENABLED=true

SESSION_COOKIE_NAME=sessionid

ALLOWED_HOSTS=yourdomain.com,localhost,000.0.0.0

CORS_ORIGINS=https://yourdomain.com, http://localhost:0000

DEBUG=true

# 8 üìö **RAG-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ (ChromaDB) (`chroma_utils.py`)**
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** —Ç–æ–Ω–∫–∞—è –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ ChromaDB (HTTP) –¥–ª—è RAG: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –ø–æ–∏—Å–∫ –ø–æ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞–º, —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º, —á—Ç–µ–Ω–∏–µ ¬´–ø–æ–ª–Ω–æ–π —Å—Ç–∞—Ç—å–∏¬ª –∏–∑ Markdown (fallback), –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–π.

- –ö–æ–ª–ª–µ–∫—Ü–∏–∏: **`faq_leadinc`** –∏ **`analytics_leadinc`**. –ò—Å—Ç–æ—á–Ω–∏–∫–∏ `.md` –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ ‚Üí –≤ –ø—É–±–ª–∏—á–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç.
- –ù–∞—Ä–µ–∑–∫–∞/–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è: `scripts_ChromaDB/scripts_ChromaDB.py` (FAQ) –∏ –ø–ª–∞–Ω/–æ–ø–∏—Å–∞–Ω–∏–µ `analytic/script_2_collection_RAG.md` (Analytics).
- –ö–µ—à –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: `analytic/_titles_emb_cache.json`.
- –ü—Ä–∞–≤–∏–ª–æ: –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **—Ä–æ–≤–Ω–æ –æ–¥–Ω—É** –∫–æ–ª–ª–µ–∫—Ü–∏—é (FAQ **–∏–ª–∏** Analytics), –±–µ–∑ —Å–º–µ—à–∏–≤–∞–Ω–∏—è.
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–ø—É—Å–∞: –∑–∞–º–µ–Ω–∏—Ç—å `.md` ‚Üí –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ ‚Üí –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend.

**—Ñ—É–Ω–∫—Ü–∏–∏:**
- `connect_to_chromadb() -> chromadb.HttpClient`  
  –°–æ–∑–¥–∞—ë—Ç HTTP-–∫–ª–∏–µ–Ω—Ç. –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∏ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è.
- `get_collection(collection_name: str)`  
  –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–ª–µ–∫—Ü–∏—é —á–µ—Ä–µ–∑ –∫–ª–∏–µ–Ω—Ç.
- `search_chunks_by_embedding(query_emb: List[float], n_results=5, collection_name=..., filters=None) -> List[Dict]`  
  –î–µ–ª–∞–µ—Ç `collection.query(..., include=["documents","metadatas","distances"])`.  
  –í–Ω—É—Ç—Ä–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç **`internal_k = max(n_results, 12)`** –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏, –Ω–∞—Ä—É–∂—É –æ—Ç–¥–∞—ë—Ç —Ä–æ–≤–Ω–æ `n_results`.  
  –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç `tags` –∫ —Å–ø–∏—Å–∫—É: `list | str | None ‚Üí List[str]`.  
  **–í—ã–¥–∞—ë—Ç —ç–ª–µ–º–µ–Ω—Ç—ã —Å–æ —Å—Ö–µ–º–æ–π:** `article_id`, `title`, `meta_tags`, `tags: List[str]`, `summary`, `text`.
- `filter_chunks(collection_name=..., article_id=None, meta_tags=None, tags=None, title=None, summary=None, limit=10) -> List[Dict]`  
  –î–µ–ª–∞–µ—Ç `collection.get(where=filters, limit=limit)`. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç—É –∂–µ —Å—Ö–µ–º—É, —á—Ç–æ –∏ `search_chunks_by_embedding`.
- `get_full_article(article_id: str, articles_file=ARTICLES_FILE) -> str`  
  –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–∏—Ç–∞–µ—Ç –æ–±—â–∏–π Markdown, –¥–µ–ª–∏—Ç –ø–æ `---`, –∏—â–µ—Ç –±–ª–æ–∫ –ø–æ —à–∞–±–ª–æ–Ω—É `article_id: "<digits>"`.  
  –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç** –±–ª–æ–∫–∞ –∫–∞–∫ –µ—Å—Ç—å.  
  –§–æ–ª–±—ç–∫–∏: —Ñ–∞–π–ª–∞ –Ω–µ—Ç ‚Üí `"–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞."`; –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Üí `"–°—Ç–∞—Ç—å—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."`  
  > –¢—Ä–µ–±—É–µ—Ç—Å—è **—á–∏—Å–ª–æ–≤–æ–π** `article_id` –≤ **–∫–∞–≤—ã—á–∫–∞—Ö**.
- `list_collections() -> list`  
  –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ–ª–ª–µ–∫—Ü–∏–π `client.list_collections()` –∏ –ª–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

**–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã Chroma ‚Äî —á–µ—Ä–µ–∑ `run_in_executor` (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º event loop).
- –ß—Ç–µ–Ω–∏–µ Markdown ‚Äî `aiofiles` (async).
- –í `search_chunks_by_embedding` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø—É–ª (**`internal_k`**) –∏ –ø–æ—Å–ª–µ–¥—É—é—â–∞—è –æ–±—Ä–µ–∑–∫–∞ –¥–æ `n_results`.

# 9 üß† –ú–æ–¥—É–ª—å OpenAI –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è (`openai_utils.py`)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –≤—ã–∑–æ–≤—ã OpenAI (—á–∞—Ç + —ç–º–±–µ–¥–¥–∏–Ω–≥–∏), –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (`FAQ` / `ANALYTICS` / `REGISTRATION` / `OFFTOPIC`), —Ä–∞–±–æ—Ç—É —Å RAG-tools –∏ **—Å—Ç—Ä–æ–≥—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é** JSON-–æ—Ç–≤–µ—Ç–∞ LLM.

**–ñ—ë—Å—Ç–∫–∏–π JSON-–∫–æ–Ω—Ç—Ä–∞–∫—Ç –æ—Ç–≤–µ—Ç–∞ LLM**
–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç **–≤—Å–µ–≥–¥–∞** –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–¥–∏–Ω JSON-–æ–±—ä–µ–∫—Ç.

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- scenario, action, reply ‚Äî –≤—Å–µ–≥–¥–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç.
- fields ‚Äî –æ–±—ä–µ–∫—Ç (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º).
- stage –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ REGISTRATION.

**–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è**
- ask_openai(input, context, history, ...) -> dict
- –î–µ–ª–∞–µ—Ç –¥–æ 5 –∏—Ç–µ—Ä–∞—Ü–∏–π tool-–≤—ã–∑–æ–≤–æ–≤ (auto tool-choice), –∑–∞—Ç–µ–º –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π JSON.
- –ï—Å–ª–∏ context.faq_article —É–∂–µ –µ—Å—Ç—å (confirm), –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã FAQ –Ω–µ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ.
- –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –æ—Ç–≤–µ—Ç: –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ç–∏–ø—ã, –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç action –≤ fields.action (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ), —á–∏—Å—Ç–∏—Ç stage –≤–Ω–µ REGISTRATION.
- –î–ª—è ANALYTICS: —Ç–∞–±–ª–∏—Ü–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ—Ç—Å—è –≤ dashboard.table —Ç–æ–ª—å–∫–æ –≤ —Ñ–∏–Ω–∞–ª–µ (—ç–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤).

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (Tools):**
read_file(path) ‚Äî —á—Ç–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–Ω—ã—Ö .md –∏–∑ –∂—ë—Å—Ç–∫–æ–≥–æ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞:
- ~/ai-assistant/backend/scenario/scenario_faq.md,
- ~/ai-assistant/backend/scenario/scenario_analytics.md,
- ~/ai-assistant/backend/scenario/scenario_registration.md
- –ö—ç—à: TTL=2 —á–∞—Å–∞, –¥–æ 6 –∑–∞–ø–∏—Å–µ–π (LRU-–ø–æ–¥–æ–±–Ω–æ), –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ mtime.

- faq_search(query, n_results=5, last_article_id=None) ‚Äî —Å–µ–º–ø–æ–∏—Å–∫ –ø–æ FAQ (–¥–æ 5 —Å—Ç–∞—Ç–µ–π: article_id, title, summary, tags, meta_tags); last_article_id –∏—Å–∫–ª—é—á–∞–µ—Ç—Å—è –∏–∑ –≤—ã–¥–∞—á–∏.
- faq_get_by_id(article_id) ‚Äî –ø–æ–ª–Ω–∞—è FAQ-—Å—Ç–∞—Ç—å—è. –ò—Å—Ç–æ—á–Ω–∏–∫: Chroma (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ/–¥–æ–∫) –∏–ª–∏ fallback –Ω–∞ markdown (fulltext).
- analytics_titles_search(query, n_results<=25) ‚Äî shortlist –Ω–∞–∑–≤–∞–Ω–∏–π –Ω–∏—à (3‚Äì25 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤) –ø–æ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
- analytics_titles_random(n=5..30) ‚Äî —Å–ª—É—á–∞–π–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –Ω–∏—à –∏–∑ —Ñ–∞–π–ª–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
- analytics_search(query) ‚Äî —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Å–µ–º–ø–æ–∏—Å–∫ –ø–æ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏.
- analytics_get_by_niche(niche) ‚Äî —Ç–æ—á–µ—á–Ω–∞—è –≤—ã–¥–∞—á–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –Ω–∏—à–∏:
    - where-—Ñ–∏–ª—å—Ç—Ä ‚Üí –ø—Ä–∏ –Ω–µ—É—Å–ø–µ—Ö–µ –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä ‚Üí –ø—Ä–∏ –Ω–µ—É—Å–ø–µ—Ö–µ fuzzy (SequenceMatcher, –ø–æ—Ä–æ–≥ ‚â• 0.72).
    - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç {"analytic": {...}} (–∫–ª—é—á–∏: –ë–∏–∑–Ω–µ—Å –Ω–∏—à–∞, analytics, table ‚Äî –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏).

–ö—ç—à –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (shortlist)

–ò—Å—Ç–æ—á–Ω–∏–∫ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤: analytic/analytic_zagolovkov.md (_TITLES_PATH)

–ö—ç—à —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤: analytic/_titles_emb_cache.json (EMB_CACHE_PATH)

–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ mtime –∏—Å—Ö–æ–¥–Ω–∏–∫–∞; –±–∞—Ç—á–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ –ø–æ 128 —Å—Ç—Ä–æ–∫.

**–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã:**
- INTERNAL_POOL=25 (—Ç–æ–ø –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ –∫–æ—Å–∏–Ω—É—Å—É –ø–µ—Ä–µ–¥ –æ–±—Ä–µ–∑–∫–æ–π),
- DEFAULT_TOOL_RETURN=25, MAX_TOOL_RETURN_HARD=25 (–≤–µ—Ä—Ö–Ω–∏–µ –ª–∏–º–∏—Ç—ã –≤—ã–¥–∞—á–∏),
- DEFAULT_SHOW=5 (–æ—Ä–∏–µ–Ω—Ç–∏—Ä ¬´—Å–∫–æ–ª—å–∫–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é¬ª).

# 10 üßµ –ì–æ–ª–æ—Å–æ–≤–æ–π —Å—Ç–µ–∫ (STT/TTS). Celery-–∑–∞–¥–∞—á–∏
**(`backend/tasks/__init__.py`) –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** —Ç–æ—á–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–¥–ø–∞–∫–µ—Ç–∞ –∑–∞–¥–∞—á –∏ –µ–¥–∏–Ω—ã–π —Ä–µ—ç–∫—Å–ø–æ—Ä—Ç. –¢—É—Ç –∂–µ ‚Äî –æ–±—â–∏–π –ª–æ–≥–≥–µ—Ä –∑–∞–¥–∞—á –∏ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å –æ—à–∏–±–æ–∫ –≤ —Ñ–∞–π–ª–æ–≤—ã–π –∂—É—Ä–Ω–∞–ª.

- **OpenAI STT (Whisper)** ‚Äî `openai==1.26.0` (–ø–∏–Ω `httpx==0.27.2`).
- **ElevenLabs TTS** ‚Äî `elevenlabs==2.7.1`. –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã 2 –≥–æ–ª–æ—Å–∞ (–æ—Å–Ω–æ–≤–Ω–æ–π + —Ä–µ–∑–µ—Ä–≤). –í—ã—Ö–æ–¥: `mp3` (web), `m4a` (macOS/iOS), `ogg` (Telegram).
- **–•—Ä–∞–Ω–µ–Ω–∏–µ/–æ—á–∏—Å—Ç–∫–∞** ‚Äî —Ñ–∞–π–ª—ã –≤ `backend/media/audio`; –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ `scripts/cleanup_audio.sh` (—Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å `+x`; —Ç–∞–π–º–µ—Ä ‚Äî —Ä–∞–∑ –≤ N –¥–Ω–µ–π).
- **–û—á–µ—Ä–µ–¥–∏** ‚Äî —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω—ã (2 –≤–æ—Ä–∫–µ—Ä–∞ `text`, 2 –≤–æ—Ä–∫–µ—Ä–∞ `audio`).
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ—Ä–∫–µ—Ä–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤ –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.

**–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã, —Ç–∞–π–º–∏–Ω–≥–∏, SLA (—Å–º. `audio_constants.py`)**

**–ü—É–±–ª–∏—á–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã (—Ä–µ—ç–∫—Å–ø–æ—Ä—Ç)**
  - `stt_task` ‚Äî —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ (–∏–∑ `backend/tasks/stt.py`)
  - `tts_task` ‚Äî —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ (–∏–∑ `backend/tasks/tts.py`)
  - `process_text` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è/–¥–∏–∞–ª–æ–≥–∞ (–∏–∑ `backend/tasks/chat.py`)
  - `log_error_to_db` ‚Äî –∑–∞–ø–∏—Å—å –æ—à–∏–±–æ–∫ –≤ `ErrorLog` (–∏–∑ `backend/utils/error_log_utils.py`)

**-  TTS-–∑–∞–¥–∞—á–∞ (`tasks/tts.py`)**
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** Celery-–∑–∞–¥–∞—á–∞ `tts_task` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–π –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ ElevenLabs (–æ—á–µ—Ä–µ–¥—å: `audio`, —Å SLA/—Ç–∞–π–º-–ª–∏–º–∏—Ç–∞–º–∏).

**-  STT-–∑–∞–¥–∞—á–∞ (`backend/tasks/stt.py`)**
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** Celery-–∑–∞–¥–∞—á–∞ `stt_task` —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç —Ä–µ—á—å —á–µ—Ä–µ–∑ OpenAI Whisper (–æ—á–µ—Ä–µ–¥—å: `audio`, –∫–æ–Ω—Ç—Ä–æ–ª—å SLA –∏ —Ç–∞–π–º-–ª–∏–º–∏—Ç–æ–≤).

**-  –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∞—É–¥–∏–æ (`backend/utils/audio_constants.py`)**
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –ø—Ä–∞–≤–¥—ã –¥–ª—è –∞—É–¥–∏–æ—Å—Ç–µ–∫–∞ (STT/TTS): —Ñ–æ—Ä–º–∞—Ç—ã, –ª–∏–º–∏—Ç—ã, SLA/—Ç–∞–π–º-–∞—É—Ç—ã, –ø—Ä–µ—Å–µ—Ç—ã –∫–æ–¥–µ–∫–æ–≤, —Ä–µ—Ç—Ä–∞–∏.

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã**
- **–í—Ö–æ–¥/—Ö—Ä–∞–Ω–µ–Ω–∏–µ:** `ALLOWED_EXTENSIONS = {".mp3", ".ogg", ".m4a", ".webm"}`
- **–í—ã–¥–∞—á–∞ TTS (–∫–ª–∏–µ–Ω—Ç–∞–º):** `SUPPORTED_TTS_FORMATS = ["mp3","ogg","m4a","webm"]`
> ‚ÑπÔ∏è **–°–µ–π—á–∞—Å –≤ –∫–æ–¥–µ `tts_task` —Ä–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ `mp3`/`ogg`**, –∞ `stt_task` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–æ–ª—å–∫–æ `mp3`/`ogg`.

**-  STT-—É—Ç–∏–ª–∏—Ç—ã (`utils/stt_utils.py`)**
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –∞—Å—Å–∏—Å—Ç–∏—Ä—É—é—Ç –≥–æ–ª–æ—Å–æ–≤–æ–º—É —Å—Ç–µ–∫—É (Whisper/STT): —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã, –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç –∏ **–±–µ–∑–æ–ø–∞—Å–Ω–æ** –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç `ogg‚Üímp3` —á–µ—Ä–µ–∑ ffmpeg, –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –∞—É–¥–∏–æ –≤ OpenAI Whisper, –ª–æ–≥–∏—Ä—É—é—Ç –æ—à–∏–±–∫–∏/–º–µ—Ç—Ä–∏–∫–∏.

**-  TTS-—É—Ç–∏–ª–∏—Ç—ã (`utils/tts_utils.py`)**
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–ª–æ–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ—á–∏ —á–µ—Ä–µ–∑ **ElevenLabs**. –†–∞–±–æ—Ç–∞–µ—Ç –∏ –∏–∑ Celery, –∏ –∏–∑ FastAPI: —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ SDK + –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞ (`run_in_executor`). –ï–¥–∏–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –≤–æ–∑–≤—Ä–∞—Ç–∞ (—É—Å–ø–µ—Ö/—Ñ–æ–ª–±—ç–∫), –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, SLA, —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤.

**-  Chat-–∑–∞–¥–∞—á–∞ (`tasks/chat.py`)**
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã (—á–∞—Ç) —Å –≤—ã–∑–æ–≤–æ–º LLM —á–µ—Ä–µ–∑ `openai_utils.ask_openai`, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î –≤—Ö–æ–¥/–≤—ã—Ö–æ–¥, –º–µ—Ä—è–µ—Ç SLA –∏ –ª–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫–∏.

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Celery (`celeryconfig.py`)**
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –µ–¥–∏–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Celery –¥–ª—è Leadinc AI Assistant.  
–ë—Ä–æ–∫–µ—Ä –∏ result backend ‚Äî **Redis** (–∞–¥—Ä–µ—Å –±–µ—Ä—ë—Ç—Å—è –∏–∑ `.env.backend` ‚Üí `backend.config.REDIS_URL`).

**-  Celery-–≤–æ—Ä–∫–µ—Ä (`celery_worker.py`)**
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å Celery-–≤–æ—Ä–∫–µ—Ä–∞ Leadinc AI. –ü–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥ –∏–∑ `backend.celeryconfig`, —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á–∏ (`chat`, `stt`, `tts`) –∏ –ª–æ–≥–∏—Ä—É–µ—Ç –∏—Ö –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª.

**-  –ë–∞–∑–æ–≤—ã–µ –∞—É–¥–∏–æ-—É—Ç–∏–ª–∏—Ç—ã (`utils/audio_utils.py`)**
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –∞—É–¥–∏–æ –¥–ª—è FastAPI –∏ Celery (STT/TTS): –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞/—Ä–∞–∑–º–µ—Ä–∞/–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ (`mp3/ogg/m4a`), –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è**
- –¢—Ä–µ–±—É—é—Ç—Å—è `ffmpeg` –∏ `ffprobe` –≤ `PATH` (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `ffmpeg-python` –∏ `pydub.utils.mediainfo`)
- –õ–æ–≥–∏ ‚Äî –æ–±—â–∏–π `leadinc-backend`; –æ—à–∏–±–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∏–¥—É—Ç –≤ —Ñ–∞–π–ª–æ–≤—ã–π –∂—É—Ä–Ω–∞–ª `ErrorLog` (`log_error_to_db`)

# 11üîå –í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã
**Code-service:**
- `POST /api/generate-code` ‚Äî –≤—ã–¥–∞—á–∞ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–≥–æ 6-–∑–Ω–∞—á–Ω–æ–≥–æ –∫–æ–¥–∞ (TTL 10 –º–∏–Ω; —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis).
- `POST /api/verify-code` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ ¬´—Å–∂–∏–≥–∞–Ω–∏–µ¬ª –∫–æ–¥–∞.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (Stage 1‚Üí2).

**Nginx:**
- –ü—Ä–æ–∫—Å–∏—Ä—É–µ—Ç `/ai/*` –∏ `/auth/*` ‚Üí FastAPI
- –†–∞–∑–¥–∞—ë—Ç `/static/` –∏ `/media/`.
- –í–∫–ª—é—á–µ–Ω—ã –∑–∞–≥–æ–ª–æ–≤–∫–∏ COOP/COEP (–∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞).
- 80 ‚Üí 443 —Ä–µ–¥–∏—Ä–µ–∫—Ç. –î–ª—è —Ç–µ—Å—Ç–æ–≤ ‚Äî —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π SSL.

**CORS:**
- –†–∞–∑—Ä–µ—à–µ–Ω—ã –¥–æ–º–µ–Ω—ã –∏–∑ `ALLOWED_ORIGINS`.


# 12 üì° API –æ–±–∑–æ—Ä
- `POST /ai/chat` ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –¥–∏–∞–ª–æ–≥–∞ (–º–∞—Ä—à—Ä—É—Ç–∏—Ç —Å—Ü–µ–Ω–∞—Ä–∏–∏; RAG, –ª–∏–º–∏—Ç—ã, —Å—Ç–∞–¥–∏–∏).
- `GET /health` ‚Äî health-check
- - `GET /auth/users/me` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
  ‚Ü≥ `401` ‚Üí `{"is_authenticated": false}`; –ø—Ä–∏ —É—Å–ø–µ—Ö–µ ‚Üí –ø—Ä–æ—Ñ–∏–ª—å `{is_authenticated, id, login}`
- `POST /auth/jwt/login_custom` ‚Äî –∫–∞—Å—Ç–æ–º–Ω—ã–π –ª–æ–≥–∏–Ω  
  - `sessionid` ‚Äî **12 —á–∞—Å–æ–≤**, `HttpOnly`, `Secure=!DEBUG`, `SameSite=Strict|Lax`
  - `fastapiusersauth` ‚Äî **JWT (7 –¥–Ω–µ–π)**, —Ç–µ –∂–µ –∞—Ç—Ä–∏–±—É—Ç—ã
  > JWT-—Å—Ç—Ä–∞—Ç–µ–≥–∏—è: `JWTStrategy(secret=SECRET, lifetime_seconds=604800, token_audience="fastapi-users")`- `POST /auth/register` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

- POST /ai/voice_upload ‚Äî —Å–æ–∑–¥–∞—ë—Ç stt_task –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç task_id

- `POST /auth/jwt/logout` ‚Äî –ª–æ–≥–∞—É—Ç  
  –û—á–∏—â–∞–µ—Ç Redis-—Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –∏ —É–¥–∞–ª—è–µ—Ç –∫—É–∫–∏: `sessionid`, `fastapiusersauth`, `SESSION_COOKIE_NAME` (—á–µ—Ä–µ–∑ `delete_cookie` + –ø—É—Å—Ç–∞—è –∫—É–∫–∞ `max_age=0`).

**–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ (–≤–Ω–µ—à–Ω–∏–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å code-service):**
- `POST /api/generate-code` ‚Äî –≤—ã–¥–∞—á–∞ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–≥–æ –∫–æ–¥–∞
- `POST /api/verify-code` ‚Äî –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ–¥–∞

# 13 üóÑÔ∏è ORM –º–æ–¥–µ–ª–∏
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –µ–¥–∏–Ω—ã–π —Å–ª–æ–π –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å–µ—Å—Å–∏–π, —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∞—É–¥–∏–æ—Å–æ–±—ã—Ç–∏–π, —á—Ç–æ–±—ã —á–∞—Ç/–≥–æ–ª–æ—Å, RAG –∏ —Å—Ç–∞–¥–∏–π–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∂–∏–ª–∏ –Ω–∞ –æ–±—â–µ–π –∏—Å—Ç–æ—Ä–∏—è—Ö –∏ –ª–∏–º–∏—Ç–∞—Ö.**

–ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–æ:
- PK –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü ‚Äî UUID (UUID(as_uuid=True)).
- –í—Ä–µ–º—è ‚Äî DateTime –±–µ–∑ TZ; —Ç—Ä–∞–∫—Ç—É–µ–º –∫–∞–∫ UTC (–∏—Å–ø–æ–ª—å–∑—É–µ–º datetime.utcnow()).
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –≤ FastAPI (engine asyncpg), —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π ‚Äî –¥–ª—è Celery/–º–∏–≥—Ä–∞—Ü–∏–π (psycopg2).
- –¢—è–∂—ë–ª—ã–µ –ø–æ–ª—è (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, usage, —Ç—Ä–∞—Å—Å–∏–Ω–≥) ‚Äî JSONB.
- –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø–æ ¬´–≥–æ—Ä—è—á–∏–º¬ª —Ñ–∏–ª—å—Ç—Ä–∞–º: session_id, user_id, created_at, status.
- –ë–∞–∑–∞: PostgreSQL 14. –ú–∏–≥—Ä–∞—Ü–∏–∏ ‚Äî Alembic (–∫–∞—Ç–∞–ª–æ–≥ alembic/versions).
- **ORM:** SQLAlchemy **2.x**, –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏.

# 14 üßµ Async / Sync-—Å–µ—Å—Å–∏–∏

- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Äî **async** (FastAPI, async SQLAlchemy engine/session).
- **Celery** –∏ **Alembic** –∏—Å–ø–æ–ª—å–∑—É—é—Ç **sync-—Å–µ—Å—Å–∏–∏** (—Å–º. `backend/database.py`).
- **–ü—Ä–∞–≤–∏–ª–æ:** –Ω–µ –º–∏–∫—Å–æ–≤–∞—Ç—å async-—Å–µ—Å—Å–∏—é –≤ Celery –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç.  
  –î–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á –∏ –º–∏–≥—Ä–∞—Ü–∏–π –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π **sync** sessionmaker/engine.

# 15 üóÉÔ∏è –ú–æ–¥—É–ª—å –ë–î (`database.py`): –¥–≤–∏–∂–∫–∏ –∏ —Å–µ—Å—Å–∏–∏

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–≤—É—Ö SQLAlchemy-–¥–≤–∏–∂–∫–æ–≤ –∏ —Ñ–∞–±—Ä–∏–∫ —Å–µ—Å—Å–∏–π:

- **Async –¥–ª—è FastAPI**  
  - `engine = create_async_engine(DATABASE_URL, echo=False)`  
  - `SessionLocal = sessionmaker(class_=AsyncSession, expire_on_commit=False, autoflush=False, autocommit=False)`  
  - –î—Ä–∞–π–≤–µ—Ä: **asyncpg**  
  - DSN: `postgresql+asyncpg://{USER}:{PASS}@{HOST}:{PORT}/{DB}`

- **Sync –¥–ª—è Celery/CLI/Alembic**  
  - `engine_sync = create_engine(DATABASE_URL_SYNC, pool_pre_ping=True, pool_recycle=3600)`  
  - `SessionLocalSync = sessionmaker(expire_on_commit=False, autoflush=False, autocommit=False)`  
  - –î—Ä–∞–π–≤–µ—Ä: **psycopg2**  
  - DSN: `postgresql+psycopg2://{USER}:{PASS}@{HOST}:{PORT}/{DB}`

- **–ë–∞–∑–∞ ORM:**  
  - `Base = declarative_base()` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `models.py`)

**ENV-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–∏–∑ `backend.config` / `.env.backend`):**  
`POSTGRES_HOST`, `POSTGRES_PORT` (**0000**), `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB`.

> –í –ø—Ä–æ–¥/—Å—Ç–µ–Ω–¥–∞—Ö –ø—Ä–æ–≤–µ—Ä—å, —á—Ç–æ `POSTGRES_PORT=....` –≤ `.env.backend` –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ö Alembic/systemd. –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ—Ä—Ç–∞ ‚áí `Connection refused`.

# 16 üß¨ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î (Alembic)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î (PostgreSQL). –ö–æ–Ω—Ñ–∏–≥ ‚Äî `alembic.ini`, —Å–∫—Ä–∏–ø—Ç—ã ‚Äî –≤ `alembic/` (—Ä–µ–≤–∏–∑–∏–∏ –≤ `alembic/versions/`).

** üîß –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `alembic.ini`**
- `script_location = %(here)s/alembic` ‚Äî –∫–∞—Ç–∞–ª–æ–≥ –º–∏–≥—Ä–∞—Ü–∏–π
- `prepend_sys_path = .` ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ `PYTHONPATH` (—á—Ç–æ–±—ã `env.py` –º–æ–≥ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `backend.*`)
- `path_separator = os` ‚Äî –∫—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
- `sqlalchemy.url =` **(–ø—É—Å—Ç–æ)** ‚Äî DSN –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏** –∏–∑ `env.py`/–ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è. –°–µ–∫—Ä–µ—Ç—ã –≤ git **–Ω–µ** —Ö—Ä–∞–Ω–∏–º.

** üîó –û—Ç–∫—É–¥–∞ –±–µ—Ä—ë—Ç—Å—è DSN**
–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–±–∏—Ä–∞—Ç—å DSN –≤ `alembic/env.py` –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:

**–ü—Ä–∏–º–µ—Ä sync-DSN (psycopg2) –¥–ª—è Alembic:**
  - postgresql+psycopg2://....:***@000.0.0.0:0000/database_name

**—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–≤–∏–∑–∏—é –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º –º–æ–¥–µ–ª–µ–π**
alembic revision --autogenerate -m "–æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π"

**–ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏**
alembic upgrade head

**–æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –Ω–∞ –æ–¥–Ω—É —Ä–µ–≤–∏–∑–∏—é**
alembic downgrade -1

# 17 üß∞ –ú–æ–¥—É–ª—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (`config.py`)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ —á—Ç–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –∏—Ö —Ç–∏–ø–∏–∑–∞—Ü–∏–∏/–¥–µ—Ñ–æ–ª—Ç–æ–≤ –¥–ª—è –≤—Å–µ–≥–æ –±—ç–∫–µ–Ω–¥–∞.

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏:**
- –ü—ã—Ç–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å `/.env.backend` –ø–æ –ø—É—Ç–∏: `/ai-assistant/backend/.env.backend`

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã**
- `SECRET` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ–∫—Ä–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (JWT, reset/verify —Ç–æ–∫–µ–Ω—ã)
- `SECRET_ADMIN_TOKEN` ‚Äî —Å–ª—É–∂–µ–±–Ω—ã–π –∞–¥–º–∏–Ω-—Ç–æ–∫–µ–Ω (–µ—Å–ª–∏ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω)

**RAG / ChromaDB**
- `CHROMA_HOST` (–¥–µ—Ñ–æ–ª—Ç `localhost`), `CHROMA_PORT` (int, –¥–µ—Ñ–æ–ª—Ç)
- –ù—É–∂–Ω—ã RAG-—É—Ç–∏–ª–∏—Ç–∞–º –∏ health-check‚Äô—É –∫–æ–ª–ª–µ–∫—Ü–∏–π

**–í–µ–±-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
- `ALLOWED_HOSTS` ‚Äî CSV-—Å—Ç—Ä–æ–∫–∞ –¥–æ–º–µ–Ω–æ–≤ (–ø–∞—Ä—Å–∏—Ç—Å—è –≤ —Å–ø–∏—Å–æ–∫)
- `CORS_ORIGINS` ‚Äî **CSV** –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ CORS (—É–∫–∞–∑—ã–≤–∞–π—Ç–µ —Å–æ —Å—Ö–µ–º–æ–π: `https://example.com`)
- `SESSION_COOKIE_NAME` ‚Äî –¥–µ—Ñ–æ–ª—Ç `sessionid`

**–ü–æ—á—Ç–∞**
- `EMAILS_FROM_EMAIL` / `EMAILS_FROM_NAME`
- `SMTP_HOST`, `SMTP_PORT` (int, –¥–µ—Ñ–æ–ª—Ç), `SMTP_USER`, `SMTP_PASSWORD`
- `EMAIL_RESET_TOKEN_EXPIRE_HOURS`
- `EMAIL_TEMPLATES_DIR` ‚Äî –¥–µ—Ñ–æ–ª—Ç `./email-templates`
- `SUPPORT_EMAIL` ‚Äî –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω, –±–µ—Ä—ë—Ç—Å—è –∏–∑ `EMAILS_FROM_EMAIL`

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ/–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥/–º–µ—Ç—Ä–∏–∫–∏**
- `LOG_LEVEL` ‚Äî –¥–µ—Ñ–æ–ª—Ç `INFO`
- `SENTRY_DSN` ‚Äî –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- `ADMIN_EMAIL` ‚Äî –¥–ª—è —Å–ª—É–∂–µ–±–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- `GA_MEASUREMENT_ID`, `METRIKA_ID` ‚Äî –ø—Ä–æ–∫–∏–¥—ã–≤–∞—é—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏ middleware
- `ENVIRONMENT` ‚Äî –¥–µ—Ñ–æ–ª—Ç `production`
- `TIMEZONE` ‚Äî –¥–µ—Ñ–æ–ª—Ç `Europe/Moscow`

**–§–æ—Ä–º–∞—Ç –∏ –ø–∞—Ä—Å–∏–Ω–≥ –∑–Ω–∞—á–µ–Ω–∏–π**
- –ë—É–ª–µ–≤—ã: `os.getenv(..., "false").lower() == "true"`
- –ü–æ—Ä—Ç—ã (`SMTP_PORT`, `CHROMA_PORT`) –ø—Ä–∏–≤–æ–¥—è—Ç—Å—è –∫ `int`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**
- **–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã:** –∑–Ω–∞—á–µ–Ω–∏—è –≤ `.env.backend` –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å `.env.docker` –∏ —Ç–µ–º, —á—Ç–æ –ø—Ä–æ–±—Ä–æ—à–µ–Ω–æ –≤ systemd/compose (–æ—Å–æ–±–µ–Ω–Ω–æ `POSTGRES_PORT=0000`)
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ `CORS_ORIGINS/ALLOWED_HOSTS` –≤ –ø—Ä–æ–¥–µ
- **–û—Ç–ª–∞–¥–æ—á–Ω—ã–µ `print(...)`:** –≤—Ä–µ–º–µ–Ω–Ω–æ –≤–∫–ª—é—á–µ–Ω—ã –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è ‚Äî **—É–±—Ä–∞—Ç—å –≤ –ø—Ä–æ–¥–µ** –∏–ª–∏ –æ–±–µ—Ä–Ω—É—Ç—å –≤ `if DEBUG:`

# 18 üë§ User Manager (fastapi-users)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** —É–ø—Ä–∞–≤–ª—è–µ—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è, –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è) –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ `FastAPIUsers` (—Å–º. `auth.py`).

**–•—Ä–∞–Ω–∏–ª–∏—â–µ –∏ —Å–µ—Å—Å–∏–∏**
- –ë—ç–∫—ç–Ω–¥ —Ö—Ä–∞–Ω–µ–Ω–∏—è: `SQLAlchemyUserDatabase(session, User)`
- –°–µ—Å—Å–∏—è: –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∏–∑ `SessionLocal`
- –§–∞–±—Ä–∏–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: `get_user_manager()` ‚Äî **async –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä**, –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–µ—Å—Å–∏—é (`async with SessionLocal()`)

**–°–µ–∫—Ä–µ—Ç—ã/—Ç–æ–∫–µ–Ω—ã**
- –¢–æ–∫–µ–Ω—ã fastapi-users –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–µ–¥–∏–Ω—ã–π `SECRET`**:
  - `verification_token_secret = SECRET`
- –¢–æ—Ç –∂–µ `SECRET` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è **JWT** (—Å–º. `auth.py`).
- ‚ö†Ô∏è –†–æ—Ç–∞—Ü–∏—è `SECRET` –¥–æ–ª–∂–Ω–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å —É—á—ë—Ç–æ–º **–≤—Å–µ—Ö** —Ç–∏–ø–æ–≤ —Ç–æ–∫–µ–Ω–æ–≤ (JWT + reset + verify).

**–•—É–∫–∏ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ (callbacks)**
- `on_after_register(user, request)` ‚Üí —Å–µ–π—á–∞—Å –ø–∏—à–µ—Ç –≤ stdout: `‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {email}`
- `on_after_forgot_password(user, token, request)` ‚Üí stdout: `üîê ... —Ç–æ–∫–µ–Ω: {token}`
- `on_after_request_verify(user, token, request)` ‚Üí stdout: `üì© ... —Ç–æ–∫–µ–Ω: {token}`

**–ü—Ä–æ–¥-–∑–∞–º–µ—Ç–∫–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)**
- –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è **–ª–æ–≥–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω—ã** –≤ stdout. –î–ª—è –ø—Ä–æ–¥-—Ä–µ–∂–∏–º–∞ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞:
  - –æ—Ç–ø—Ä–∞–≤–∫—É –ø–∏—Å—å–º–∞ (SMTP/–ø–æ—á—Ç–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å) —á–µ—Ä–µ–∑ `email_utils.py`, –∏–ª–∏
  - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ **–±–µ–∑ –∑–Ω–∞—á–µ–Ω–∏–π —Ç–æ–∫–µ–Ω–æ–≤** (–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ).

**–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**
- –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è —Ñ–∞–±—Ä–∏–∫–∞ `get_user_manager()` ‚Üí –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ `FastAPIUsers` –≤ `auth.py`.
- –ß–µ—Ä–µ–∑ `fastapi_users` –ø–æ–¥–Ω–∏–º–∞—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ `/auth/*` —Ä–æ—É—Ç—ã, –¥–æ—Å—Ç—É–ø–µ–Ω `current_user(...)` –∏ –¥—Ä.

# 19üßØ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π error-–ª–æ–≥–≥–µ—Ä (`error_log_utils.py`)**
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –∑–∞–ø–∏—Å–∏ **—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö JSON-–æ—à–∏–±–æ–∫** –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ (API, Celery-—Ç–∞—Å–∫–∏, —É—Ç–∏–ª–∏—Ç—ã). –ü–∏—à–µ—Ç –≤ **—Ñ–∞–π–ª–æ–≤—ã–π –∂—É—Ä–Ω–∞–ª**, –∞ –Ω–µ –≤ –ë–î.

- –§–∞–π–ª –∂—É—Ä–Ω–∞–ª–∞: **`/srv/leadinc-logs/error_log.log`**
- –õ–æ–≥–≥–µ—Ä –º–æ–¥—É–ª—è: **`leadinc-errorlog`**
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ: –±–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ `logging` (—Å–º. –≥—Ä–∞–±–ª–∏ –Ω–∏–∂–µ)

# 20 üß± –ì—Ä–∞–±–ª–∏ –∏ —á–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

- JWT + HTTPS: –≤ –±—Ä–∞—É–∑–µ—Ä–µ cookie –º–æ–≥—É—Ç –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è –Ω–∞ http ‚Üí –ª–æ–∫–∞–ª—å–Ω–æ —Å—Ç–∞–≤—å SECURE_COOKIE=false, –¥–ª—è –±–æ–µ–≤–æ–≥–æ –¥–æ–º–µ–Ω–∞ ‚Äî true –∏ —Ä–µ–∞–ª—å–Ω—ã–π HTTPS.
- –°–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç: —á–∞—Å—Ç—å –±—Ä–∞—É–∑–µ—Ä–æ–≤/–∫–ª–∏–µ–Ω—Ç–æ–≤ –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã.
- ChromaDB: —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞/—Å–µ—Ä–≤–µ—Ä–∞ –ª–æ–º–∞–µ—Ç –ø–æ–∏—Å–∫.
- Alembic: –±–∏—Ç—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ ‚Üí –æ—á–∏—Å—Ç–∏ alembic/versions, –ø—Ä–æ–≤–µ—Ä—å alembic_version –≤ –ë–î, –ø–µ—Ä–µ—Å–æ–±–µ—Ä–∏ —Ä–µ–≤–∏–∑–∏–∏.
- –ö–µ—à –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: _titles_emb_cache.json –≥–µ–Ω–µ—Ä–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
- –†–∞–∑–º–µ—Ä –∞—É–¥–∏–æ –¥–ª—è STT: –ª–∏–º–∏—Ç–∏—Ä—É–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å/—Ä–∞–∑–º–µ—Ä (–∏–Ω–∞—á–µ —Ç–∞–π–º–∞—É—Ç—ã –∏ —Ä–æ—Å—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏).
- CORS: –¥–æ–±–∞–≤—å TEST_FRONTEND_ORIGIN –¥–ª—è —Ç–µ—Å—Ç-–∫–ª–∏–µ–Ω—Ç–∞, –∏–Ω–∞—á–µ –±—Ä–∞—É–∑–µ—Ä –∑–∞—Ä–µ–∂–µ—Ç –∑–∞–ø—Ä–æ—Å—ã.
- **Async/Sync-—Å–µ—Å—Å–∏–∏:** Celery/Alembic –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **sync**-—Å–µ—Å—Å–∏—é. –û—à–∏–±–∫–∞ ‚Äúgreenlet/await‚Äù = –≥–¥–µ-—Ç–æ –ø–æ–¥–∫–ª—é—á–∏–ª–∏ –Ω–µ —Ç–æ—Ç sessionmaker.

- **–†–∞–∑–Ω—ã–µ –æ—á–µ—Ä–µ–¥–∏ Celery:** —É–±–µ–¥–∏—Å—å, —á—Ç–æ `celery-text.service` –∏ `celery-audio.service` —Ä–µ–∞–ª—å–Ω–æ —Å–ª—É—à–∞—é—Ç —Å–≤–æ–∏ –æ—á–µ—Ä–µ–¥–∏.
- **Systemd-—é–Ω–∏—Ç—ã:** —Å—Ç–∞—Ä—Ç/—Ä–µ—Å—Ç–∞—Ä—Ç –±—ç–∫–∞ –∏ ChromaDB —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ `systemctl` (–∏–Ω–∞—á–µ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å 2 –∏–Ω—Å—Ç–∞–Ω—Å–∞ –∏ —à–∞—Ç–∫–∏–π –ø–æ—Ä—Ç).

- **SQL echo –≤ –ø—Ä–æ–¥–µ:** `echo=True` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —à—É–º–Ω—ã–µ –ª–æ–≥–∏ –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç SQL/–¥–∞–Ω–Ω—ã–µ.
- **–î–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ DSN:** backend —Å–æ–±–∏—Ä–∞–µ—Ç –∏–∑ `POSTGRES_*`, alembic ‚Äî –∏–∑ `DATABASE_URL`. –î–µ—Ä–∂–∏—Ç–µ –∏—Ö **–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º–∏**.
- **Session TTL vs JWT TTL:** `sessionid` –∂–∏–≤—ë—Ç **12—á**, –∞ JWT ‚Äî **7–¥**. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π JWT –ø—Ä–∏ –∏—Å—Ç—ë–∫—à–µ–π —Å–µ—Å—Å–∏–∏ ‚Üí –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ `sessionid`.

# 21 üñºÔ∏è –°–∫—Ä–∏–Ω—à–æ—Ç—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è
<img width="2559" height="1227" alt="image" src="https://github.com/user-attachments/assets/ab0990ba-b722-4f30-b6e1-95e1bb94c66d" />
<img width="2559" height="1232" alt="image" src="https://github.com/user-attachments/assets/2ddee8fb-dce9-4394-b298-b3b22772ec9b" />
<img width="2559" height="1228" alt="image" src="https://github.com/user-attachments/assets/294e5152-a52d-4cef-81d4-29abfae4a98e" />

# 22 üìú –õ–∏—Ü–µ–Ω–∑–∏—è

–ü—Ä–æ–µ–∫—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ–¥ MIT License ‚Äî —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –≤—Å–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –∏–∑–º–µ–Ω—è—Ç—å –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è—Ç—å –∫–æ–¥.
–ê–≤—Ç–æ—Ä –Ω–µ –Ω–µ—Å—ë—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –ª—é–±—ã–º–∏ –ª–∏—Ü–∞–º–∏.

**MIT-–ª–∏—Ü–µ–Ω–∑–∏—è**

–ê–≤—Ç–æ—Ä—Å–∫–æ–µ –ø—Ä–∞–≤–æ (c) 2025 –ë–ª–æ—à–∫–æ –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–µ–≤–∏—á

–ù–∞—Å—Ç–æ—è—â–∏–º —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è, –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –ª—é–±–æ–º—É –ª–∏—Ü—É, –ø–æ–ª—É—á–∏–≤—à–µ–º—É –∫–æ–ø–∏—é –¥–∞–Ω–Ω–æ–≥–æ
–ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∏ —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (–¥–∞–ª–µ–µ ‚Äî ¬´–ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ¬ª),
–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ, –≤–∫–ª—é—á–∞—è –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø—Ä–∞–≤–∞ –Ω–∞
–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ, –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ, –∏–∑–º–µ–Ω–µ–Ω–∏–µ, —Å–ª–∏—è–Ω–∏–µ, –ø—É–±–ª–∏–∫–∞—Ü–∏—é, —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ, —Å—É–±–ª–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏–µ
–∏/–∏–ª–∏ –ø—Ä–æ–¥–∞–∂—É –∫–æ–ø–∏–π –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è, –∞ —Ç–∞–∫–∂–µ –ª–∏—Ü–∞–º, –∫–æ—Ç–æ—Ä—ã–º –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —ç—Ç–æ
–ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ, –ø—Ä–∏ —Å–æ–±–ª—é–¥–µ–Ω–∏–∏ —Å–ª–µ–¥—É—é—â–∏—Ö —É—Å–ª–æ–≤–∏–π:

–í—ã—à–µ—É–ø–æ–º—è–Ω—É—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∞–≤—Ç–æ—Ä—Å–∫–æ–º –ø—Ä–∞–≤–µ –∏ –Ω–∞—Å—Ç–æ—è—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏
–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω—ã –≤–æ –≤—Å–µ –∫–æ–ø–∏–∏ –∏–ª–∏ –∑–Ω–∞—á–∏–º—ã–µ —á–∞—Å—Ç–∏ –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è.

–ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è ¬´–ö–ê–ö –ï–°–¢–¨¬ª, –±–µ–∑ –∫–∞–∫–∏—Ö-–ª–∏–±–æ –≥–∞—Ä–∞–Ω—Ç–∏–π, —è–≤–Ω—ã—Ö –∏–ª–∏
–ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ–º—ã—Ö, –≤–∫–ª—é—á–∞—è, –ø–æ–º–∏–º–æ –ø—Ä–æ—á–µ–≥–æ, –≥–∞—Ä–∞–Ω—Ç–∏–∏ —Ç–æ–≤–∞—Ä–Ω–æ–π –ø—Ä–∏–≥–æ–¥–Ω–æ—Å—Ç–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ü–µ–ª–∏ –∏ –Ω–µ–Ω–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∞–≤. –ù–∏ –≤ –∫–æ–µ–º —Å–ª—É—á–∞–µ –∞–≤—Ç–æ—Ä—ã –∏–ª–∏ –ø—Ä–∞–≤–æ–æ–±–ª–∞–¥–∞—Ç–µ–ª–∏ –Ω–µ –Ω–µ—Å—É—Ç
–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∫–∞–∫–∏–º-–ª–∏–±–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º, —É–±—ã—Ç–∫–∞–º –∏–ª–∏ –∏–Ω—ã–º –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞–º, –±—É–¥—å —Ç–æ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É,
–¥–µ–ª–∏–∫—Ç—É –∏–ª–∏ –∏–Ω—ã–º –æ–±—Ä–∞–∑–æ–º, –≤–æ–∑–Ω–∏–∫—à–∏–º –∏–∑, –∏–∑-–∑–∞ –∏–ª–∏ –≤ —Å–≤—è–∑–∏ —Å –ü—Ä–æ–≥—Ä–∞–º–º–Ω—ã–º –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ–º
–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è, –ª–∏–±–æ –∏–Ω—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏ —Å –ü—Ä–æ–≥—Ä–∞–º–º–Ω—ã–º –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ–º.


# 23 –ö–æ–Ω—Ç–∞–∫—Ç 
Email: kdmitrievich1994@gmail.com
Telegram: Konstantikii

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


This README is provided in two languages: RU and EN. The section below is the EN.

# 1. Leadinc AI Assistant ‚Äî a smart manager-consultant server for B2B sales
<img width="2559" height="1238" alt="image_2025-09-12_13-02-56" src="https://github.com/user-attachments/assets/b75b51a7-7610-464b-880d-0ddcce7102ee" />

For business: the assistant helps sell faster and more precisely. It‚Äôs like a friendly manager who:

explains how the service works and where to start;

instantly answers any questions about the services;

runs quick registration;

delivers analytics for 1 out of 430 business niches;

reduces time spent on explanations, qualification and clarifications ‚Üí the team gets distracted less, leads are processed faster, fewer ‚Äúleaks‚Äù across funnel stages.

# 2. üß≠ TL;DR

What it is: Leadinc assistant FastAPI backend with RAG (2 collections: FAQ/Analytics), voice (STT/TTS), Redis limits, data in Postgres, vector search in ChromaDB, and Celery workers.

Why it matters for business: the assistant acts like a friendly manager ‚Äî quickly explains the product, handles registration, answers FAQs, provides analytics for 1 of 430+ niches ‚Üí less routine for the team, faster lead processing, lower funnel loss.

LLM scenarios: REGISTRATION, FAQ, ANALYTICS, OFFTOPIC. For each request ‚Äî exactly one RAG collection is used (no mixing).

Run: locally via venv (Docker is optional/for infrastructure if desired).

RAG data: private (not included in the public repository).

Status: ALPHA test (self-signed HTTPS for tests).

Where to look: ‚öôÔ∏è Quick Start ‚Üí üóÇÔ∏è Structure ‚Üí üß© Architecture ‚Üí üéØ Scenarios.

# 3 ‚öôÔ∏è Quick Start

1) Clone
git clone https://github.com/Kentokpro/gpt-assistant.git

cd ai-assistant

2) Python venv
source ~/ai-assistant/backend/venv/bin/activate

3) Dependencies
pip install -r ai-assistant/backend/requirements.txt

4) Environment variables
Create ai-assistant/backend/.env.backend.

5) Database & migrations
alembic upgrade head

6) (If required) run ChromaDB separately (version from requirements.txt)
example: chroma run --host 000.0.0.0 --port 0000

7) Start the app
uvicorn backend.main:app --host 0.0.0.0 --port 0000 --reload

8) Test front
Open frontend_test/index.html in your browser (locally) and verify connectivity to the API.

# 4. üìÇ Repository structure:
<img width="1455" height="1147" alt="image_2025-09-12_13-17-12" src="https://github.com/user-attachments/assets/a24d0dcf-b8bd-40a5-af2a-5643d7883ad1" /> <img width="1455" height="635" alt="image_2025-09-12_13-17-44" src="https://github.com/user-attachments/assets/5f9a7bc0-e6fa-4cd4-aa40-3870cff44e27" />

# 5. üß© Architecture & key logic

Infrastructure (ALPHA):

OS: Ubuntu 22.04.5 LTS (jammy), Python 3.10.12

Reverse-proxy: Nginx (443/HTTPS; self-signed for tests)

Backend: FastAPI (Uvicorn) ‚Äî gpt-backend.service on 000.0.0.0:0000

DB: PostgreSQL 14 (0000)

Cache/Rate-limit/State: Redis 6.0.16 (0000)

Vector DB: ChromaDB (HTTP 0000) ‚Äî leadinc-chroma.service

Queues: Celery ‚Äî 2 text workers, 2 audio workers (separate queues)

Codes: code-service (0000) ‚Äî one-time 6-digit codes (TTL 10 min)

Static test front: /var/www/leadinc/static/chat.html

Test Front (HTML+JS):

POST /ai/chat (text ‚Üí text/voice),

POST /ai/voice_upload (file ‚Üí STT),

POST /ai/tts (text ‚Üí audio).
Requires correct CORS (allowed origin) and cookie installation in the browser (see SECURE_COOKIES/SameSite).

Scenario routing: the assistant selects one of 4 scenarios per request. Depending on the scenario, it uses and queries exactly one RAG collection.
Assistant scenarios:

FAQ ‚Üí collection faq_leadinc (RAG)

ANALYTICS ‚Üí collection analytics_leadinc (RAG)

REGISTRATION ‚Üí stage funnel 1‚Üí3, one-time codes (code-service), history migration by user_id

OFFTOPIC ‚Üí small talk with limits

Exactly one RAG collection (FAQ or Analytics) is used per request, no mixing.

Stage logic: applied during registration guest (1‚Äì2) ‚Üí registration ‚Üí authorized (3).

Voice: upload ‚Üí STT ‚Üí response + optional TTS (file is saved and auto-cleaned).

# 6. üéØ Scenarios & capabilities

Value: quick start, fewer ‚Äúhow it works‚Äù questions, ready answers and niche analytics ‚Äî faster to sales.

REGISTRATION ‚Äî Stage funnel (1‚Üí3): confirmation code ‚Üí city/niche ‚Üí auto-registration. Creates a user, links the current session, issues a JWT, offers to proceed to analytics.

FAQ ‚Äî Answers about the service (how it works, terms, launch, what‚Äôs included). Source ‚Äî faq_leadinc (RAG).

ANALYTICS ‚Äî Provides analytics for the selected niche from analytics_leadinc (RAG).

OFFTOPIC ‚Äî Just small talk, gently guides the dialog back to the goal (configurable limits and anti-flood).

Technically:

Hybrid RAG: ChromaDB, 2 collections (FAQ/Analytics), niche titles are cached.

Auth/limits: JWT cookie, separate session cookie, stages/quotas and anti-flood in Redis. Active subscription check (whitelist e-mail ‚Äî bypass).

Voice: STT (Whisper) and TTS (ElevenLabs), auto-cleanup via timer.

Test front: static page to check the API (no production features).

# 7. üîê Environment variables (example backend/.env.backend)

JWT & general secrets
SECRET=(secret)

SECRET_ADMIN_TOKEN=(secret)

OPENAI_API_KEY=(secret)

ELEVENLABS_API_KEY=(secret)

Primary voice
ELEVENLABS_VOICE_ID=(secret)

Fallback voice substituting the primary
ELEVENLABS_FALLBACK_VOICE_ID=(secret)

Redis
REDIS_URL=redis://localhost:0000

Postgres connection
DATABASE_URL=postgresql+asyncpg://(secret):(secret)@000.0.0.0:(port)/(database_name)

POSTGRES_USER=(user_name)

POSTGRES_PASSWORD=(secret)

POSTGRES_DB=(database_name)

POSTGRES_HOST=000.0.0.0

POSTGRES_PORT=(port)

ChromaDB (RAG)
CHROMA_HOST=localhost

CHROMA_PORT=0000

Security & sessions
SECURE_COOKIES=false

CSRF_ENABLED=true

SESSION_COOKIE_NAME=sessionid

ALLOWED_HOSTS=yourdomain.com,localhost,000.0.0.0

CORS_ORIGINS=https://yourdomain.com
, http://localhost:0000

DEBUG=true

# 8 üìö RAG storage (ChromaDB) (chroma_utils.py)

Purpose: a thin wrapper over ChromaDB (HTTP) for RAG: connection, embedding search, metadata filters, reading the ‚Äúfull article‚Äù from Markdown (fallback), listing collections.

Collections: faq_leadinc and analytics_leadinc. Source .md files are private ‚Üí not included in the public repository.

Chunking/indexing: scripts_ChromaDB/scripts_ChromaDB.py (FAQ) and plan/description analytic/script_2_collection_RAG.md (Analytics).

Analytics titles cache: analytic/_titles_emb_cache.json.

Rule: per request the assistant uses exactly one collection (FAQ or Analytics), no mixing.

Updating the corpus: replace .md ‚Üí re-generate embeddings ‚Üí restart backend.

functions:

connect_to_chromadb() -> chromadb.HttpClient
Creates the HTTP client. Errors are logged and re-raised.

get_collection(collection_name: str)
Returns a collection via the client.

search_chunks_by_embedding(query_emb: List[float], n_results=5, collection_name=..., filters=None) -> List[Dict]
Calls collection.query(..., include=["documents","metadatas","distances"]).
Internally requests internal_k = max(n_results, 12) to improve relevance; externally returns exactly n_results.
Normalizes tags to list: list | str | None ‚Üí List[str].
Returns elements with schema: article_id, title, meta_tags, tags: List[str], summary, text.

filter_chunks(collection_name=..., article_id=None, meta_tags=None, tags=None, title=None, summary=None, limit=10) -> List[Dict]
Calls collection.get(where=filters, limit=limit). Returns the same schema as search_chunks_by_embedding.

get_full_article(article_id: str, articles_file=ARTICLES_FILE) -> str
Asynchronously reads the shared Markdown, splits by ---, searches for a block by pattern article_id: "<digits>".
Returns the full text of the block as-is.
Fallbacks: file missing ‚Üí "Technical error: the knowledge base is temporarily unavailable."; not found ‚Üí "Article not found."

Requires a numeric article_id in quotes.

list_collections() -> list
Returns the list of collections client.list_collections() and logs the result.

Async & performance

Potentially blocking Chroma calls ‚Äî via run_in_executor (do not block the event loop).

Markdown reading ‚Äî aiofiles (async).

search_chunks_by_embedding uses an extended pool (internal_k) and then truncates to n_results.

# 9 üß† OpenAI module & routing (openai_utils.py)

Purpose: encapsulates OpenAI calls (chat + embeddings), scenario routing (FAQ / ANALYTICS / REGISTRATION / OFFTOPIC), RAG tools, and strict validation of the LLM JSON response.

Strict JSON contract of the LLM response
The assistant always returns a single JSON object.

Requirements:

scenario, action, reply ‚Äî always present.

fields ‚Äî an object (can be empty).

stage is used only in REGISTRATION.

Main function

ask_openai(input, context, history, ...) -> dict

Performs up to 5 tool-call iterations (auto tool-choice), then returns the final JSON.

If context.faq_article is already present (confirm), FAQ tools are not re-called.

Normalizes the response: guarantees types, moves action into fields.action (if needed), clears stage outside of REGISTRATION.

For ANALYTICS: the table is kept locally and attached to dashboard.table only at the very end (token savings).

Tools:
read_file(path) ‚Äî read scenario .md from a strict allowlist:

~/ai-assistant/backend/scenario/scenario_faq.md,

~/ai-assistant/backend/scenario/scenario_analytics.md,

~/ai-assistant/backend/scenario/scenario_registration.md

Cache: TTL=2 hours, up to 6 entries (LRU-like), invalidation by mtime.

faq_search(query, n_results=5, last_article_id=None) ‚Äî semantic search over FAQ (up to 5 articles: article_id, title, summary, tags, meta_tags); last_article_id is excluded from results.

faq_get_by_id(article_id) ‚Äî full FAQ article. Source: Chroma (metadata/doc) or fallback to markdown (fulltext).

analytics_titles_search(query, n_results<=25) ‚Äî shortlist of niche titles (3‚Äì25 candidates) by title embeddings.

analytics_titles_random(n=5..30) ‚Äî random niche titles from the titles file.

analytics_search(query) ‚Äî fallback semantic search over the analytics collection.

analytics_get_by_niche(niche) ‚Äî targeted analytics by niche name:

where filter ‚Üí if not found, full scan ‚Üí if not found, fuzzy (SequenceMatcher, threshold ‚â• 0.72).

Returns {"analytic": {...}} (keys: –ë–∏–∑–Ω–µ—Å –Ω–∏—à–∞, analytics, table ‚Äî if present).

Analytics titles cache (shortlist)

Titles source: analytic/analytic_zagolovkov.md (_TITLES_PATH)

Embeddings cache: analytic/_titles_emb_cache.json (EMB_CACHE_PATH)

Invalidation by source mtime; embeddings in batches of 128 lines.

Constants:

INTERNAL_POOL=25 (top candidates by cosine before truncation),

DEFAULT_TOOL_RETURN=25, MAX_TOOL_RETURN_HARD=25 (upper limits),

DEFAULT_SHOW=5 (hint ‚Äúhow many to show the user‚Äù).

# 10 üßµ Voice stack (STT/TTS). Celery tasks

(backend/tasks/__init__.py) Purpose: initialization point of the task subpackage and unified re-export. Also: shared task logger and centralized error writing to the file journal.

OpenAI STT (Whisper) ‚Äî openai==1.26.0 (pin httpx==0.27.2).

ElevenLabs TTS ‚Äî elevenlabs==2.7.1. Two voices are configured (primary + fallback). Output: mp3 (web), m4a (macOS/iOS), ogg (Telegram).

Storage/cleanup ‚Äî files in backend/media/audio; auto-cleanup scripts/cleanup_audio.sh (file must have +x; timer ‚Äî every N days).

Queues ‚Äî background tasks split (2 text workers, 2 audio workers).

Number of workers depends on your server resources.

Constants, timings, SLA (see audio_constants.py)

Public objects (re-export)

stt_task ‚Äî speech recognition (from backend/tasks/stt.py)

tts_task ‚Äî speech synthesis (from backend/tasks/tts.py)

process_text ‚Äî text message/dialog processing (from backend/tasks/chat.py)

log_error_to_db ‚Äî write errors to the ErrorLog (from backend/utils/error_log_utils.py)

- TTS task (tasks/tts.py)
Purpose: Celery task tts_task generates a voice response via ElevenLabs (queue: audio, with SLA/time limits).

- STT task (backend/tasks/stt.py)
Purpose: Celery task stt_task recognizes speech via OpenAI Whisper (queue: audio, SLA and time-limit control).

- Audio constants (backend/utils/audio_constants.py)
Purpose: single source of truth for the audio stack (STT/TTS): formats, limits, SLA/timeouts, codec presets, retries.

Supported formats

Input/storage: ALLOWED_EXTENSIONS = {".mp3", ".ogg", ".m4a", ".webm"}

TTS output (clients): SUPPORTED_TTS_FORMATS = ["mp3","ogg","m4a","webm"]

‚ÑπÔ∏è Currently in code tts_task allows only mp3/ogg, and stt_task accepts only mp3/ogg.

- STT utils (utils/stt_utils.py)
Purpose: assist the voice stack (Whisper/STT): save uploaded files, validate and safely convert ogg‚Üímp3 via ffmpeg, send audio to OpenAI Whisper, log errors/metrics.

- TTS utils (utils/tts_utils.py)
Purpose: a universal layer for speech generation via ElevenLabs. Works from both Celery and FastAPI: synchronous SDK call + async wrapper (run_in_executor). Unified return contract (success/fallback), logging, SLA, file storage.

- Chat task (tasks/chat.py)
Purpose: processes text requests (chat) by calling LLM via openai_utils.ask_openai, saves input/output to DB, measures SLA, and logs errors.

Celery configuration (celeryconfig.py)
Purpose: unified Celery configuration for Leadinc AI Assistant.
Broker and result backend ‚Äî Redis (address from .env.backend ‚Üí backend.config.REDIS_URL).

- Celery worker (celery_worker.py)
Purpose: main Celery worker process of Leadinc AI. Loads config from backend.celeryconfig, registers tasks (chat, stt, tts) and logs their lifecycle.

- Base audio utils (utils/audio_utils.py)
Purpose: unified audio tooling for FastAPI and Celery (STT/TTS): validation of format/size/duration, conversions (mp3/ogg/m4a), cleanup of old files, logging.

Dependencies & requirements

ffmpeg and ffprobe must be in PATH (used via ffmpeg-python and pydub.utils.mediainfo)

Logs ‚Äî shared leadinc-backend; errors additionally go to the file journal ErrorLog (log_error_to_db)

# 11üîå External services

Code-service:

POST /api/generate-code ‚Äî issues a one-time 6-digit code (TTL 10 min; stored in Redis).

POST /api/verify-code ‚Äî verifies and ‚Äúburns‚Äù the code.

Used in registration (Stage 1‚Üí2).

Nginx:

Proxies /ai/* and /auth/* ‚Üí FastAPI

Serves /static/ and /media/.

COOP/COEP headers enabled (from the saved config).

80 ‚Üí 443 redirect. For tests ‚Äî self-signed SSL.

CORS:

Allowed domains from ALLOWED_ORIGINS.

# 12 üì° API overview

POST /ai/chat ‚Äî central dialog endpoint (routes scenarios; RAG, limits, stages).

GET /health ‚Äî health check

GET /auth/users/me ‚Äî check current user
‚Ü≥ 401 ‚Üí {"is_authenticated": false}; on success ‚Üí profile {is_authenticated, id, login}

POST /auth/jwt/login_custom ‚Äî custom login

sessionid ‚Äî 12 hours, HttpOnly, Secure=!DEBUG, SameSite=Strict|Lax

fastapiusersauth ‚Äî JWT (7 days), same attributes

JWT strategy: JWTStrategy(secret=SECRET, lifetime_seconds=604800, token_audience="fastapi-users")

POST /auth/register ‚Äî registration

POST /ai/voice_upload ‚Äî creates stt_task and returns task_id

POST /auth/jwt/logout ‚Äî logout
Clears Redis session state and deletes cookies: sessionid, fastapiusersauth, SESSION_COOKIE_NAME (via delete_cookie + empty cookie max_age=0).

Helper (external microservice code-service):

POST /api/generate-code ‚Äî issue a one-time code

POST /api/verify-code ‚Äî verify the code

# 13 üóÑÔ∏è ORM models

Purpose: a unified data layer for users, sessions, messages and audio events so that chat/voice, RAG, and stage logic live on shared histories and limits.

How it‚Äôs set up:

PK of all tables ‚Äî UUID (UUID(as_uuid=True)).

Time ‚Äî DateTime without TZ; treated as UTC (using datetime.utcnow()).

Async access in FastAPI (engine asyncpg), sync ‚Äî for Celery/migrations (psycopg2).

Heavy fields (metadata, usage, tracing) ‚Äî JSONB.

Indexing on ‚Äúhot‚Äù filters: session_id, user_id, created_at, status.

DB: PostgreSQL 14. Migrations ‚Äî Alembic (directory alembic/versions).

ORM: SQLAlchemy 2.x, declarative models.

# 14 üßµ Async / Sync sessions

Main app ‚Äî async (FastAPI, async SQLAlchemy engine/session).

Celery and Alembic use sync sessions (see backend/database.py).

Rule: do not mix an async session in Celery and vice versa.
For background tasks and migrations import the sync sessionmaker/engine.

# 15 üóÉÔ∏è DB module (database.py): engines & sessions

Purpose: single point for creating two SQLAlchemy engines and session factories:

Async for FastAPI

engine = create_async_engine(DATABASE_URL, echo=False)

SessionLocal = sessionmaker(class_=AsyncSession, expire_on_commit=False, autoflush=False, autocommit=False)

Driver: asyncpg

DSN: postgresql+asyncpg://{USER}:{PASS}@{HOST}:{PORT}/{DB}

Sync for Celery/CLI/Alembic

engine_sync = create_engine(DATABASE_URL_SYNC, pool_pre_ping=True, pool_recycle=3600)

SessionLocalSync = sessionmaker(expire_on_commit=False, autoflush=False, autocommit=False)

Driver: psycopg2

DSN: postgresql+psycopg2://{USER}:{PASS}@{HOST}:{PORT}/{DB}

ORM base:

Base = declarative_base() (used in models.py)

ENV variables (from backend.config / .env.backend):
POSTGRES_HOST, POSTGRES_PORT (0000), POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB.

In prod/staging ensure POSTGRES_PORT=.... in .env.backend and in Alembic/systemd configs. Port mismatch ‚áí Connection refused.

# 16 üß¨ DB migrations (Alembic)

Purpose: versioning of the DB schema (PostgreSQL). Config ‚Äî alembic.ini, scripts ‚Äî in alembic/ (revisions in alembic/versions/).

** üîß Key alembic.ini settings**

script_location = %(here)s/alembic ‚Äî migrations directory

prepend_sys_path = . ‚Äî adds repo root to PYTHONPATH (so env.py can import backend.*)

path_separator = os ‚Äî cross-platform separator

sqlalchemy.url = (empty) ‚Äî DSN is injected dynamically from env.py/environment variables. Do not store secrets in git.

** üîó Where DSN comes from**
Recommended to build DSN in alembic/env.py from environment variables:

Example sync DSN (psycopg2) for Alembic:

postgresql+psycopg2://....:***@000.0.0.0:0000/database_name

generate a revision from model changes
alembic revision --autogenerate -m "change description"

apply all migrations
alembic upgrade head

rollback one revision
alembic downgrade -1

# 17 üß∞ Config module (config.py)

Purpose: single point for reading environment variables and their typing/defaults for the entire backend.

Load order:

Attempts to load /.env.backend at path: /ai-assistant/backend/.env.backend

Mandatory secrets

SECRET ‚Äî main app secret (JWT, reset/verify tokens)

SECRET_ADMIN_TOKEN ‚Äî service admin token (if used)

RAG / ChromaDB

CHROMA_HOST (default localhost), CHROMA_PORT (int, default)

Needed by RAG utils and the collections health-check

Web settings & security

ALLOWED_HOSTS ‚Äî CSV string of domains (parsed into a list)

CORS_ORIGINS ‚Äî CSV of CORS origins (specify with scheme: https://example.com)

SESSION_COOKIE_NAME ‚Äî default sessionid

Mail

EMAILS_FROM_EMAIL / EMAILS_FROM_NAME

SMTP_HOST, SMTP_PORT (int, default), SMTP_USER, SMTP_PASSWORD

EMAIL_RESET_TOKEN_EXPIRE_HOURS

EMAIL_TEMPLATES_DIR ‚Äî default ./email-templates

SUPPORT_EMAIL ‚Äî if not set, taken from EMAILS_FROM_EMAIL

Logging/monitoring/metrics

LOG_LEVEL ‚Äî default INFO

SENTRY_DSN ‚Äî if used

ADMIN_EMAIL ‚Äî for service notifications

GA_MEASUREMENT_ID, METRIKA_ID ‚Äî injected into headers via middleware

ENVIRONMENT ‚Äî default production

TIMEZONE ‚Äî default Europe/Moscow

Format & parsing

Booleans: os.getenv(..., "false").lower() == "true"

Ports (SMTP_PORT, CHROMA_PORT) are cast to int

Recommendations

Single source of truth: values in .env.backend must match .env.docker and what‚Äôs injected into systemd/compose (especially POSTGRES_PORT=0000)

Security: correct CORS_ORIGINS/ALLOWED_HOSTS in prod

Debug print(...): temporarily enabled on module import ‚Äî remove in prod or wrap with if DEBUG:

# 18 üë§ User Manager (fastapi-users)

Purpose: manages user lifecycle (registration, password reset, verification) and is used as a dependency when initializing FastAPIUsers (see auth.py).

Storage & sessions

Storage backend: SQLAlchemyUserDatabase(session, User)

Session: async from SessionLocal

Dependency factory: get_user_manager() ‚Äî async generator, each call opens and properly closes a session (async with SessionLocal())

Secrets/tokens

fastapi-users tokens use a single SECRET:

verification_token_secret = SECRET

The same SECRET is used for JWT (see auth.py).

‚ö†Ô∏è Rotating SECRET must be planned considering all token types (JWT + reset + verify).

Lifecycle hooks (callbacks)

on_after_register(user, request) ‚Üí currently prints to stdout: ‚úÖ User registered: {email}

on_after_forgot_password(user, token, request) ‚Üí stdout: üîê ... token: {token}

on_after_request_verify(user, token, request) ‚Üí stdout: üì© ... token: {token}

Prod note (security)

Current implementation logs tokens to stdout. For prod, replace with:

sending mail (SMTP/mail service) via email_utils.py, or

structured logging without token values (masking).

Where used

Factory get_user_manager() is exported ‚Üí passed into FastAPIUsers in auth.py.

Through fastapi_users, standard /auth/* routes are mounted; current_user(...) etc. are available.

# 19üßØ Centralized error logger (error_log_utils.py)

Purpose: single point for writing structured JSON errors for the whole project (API, Celery tasks, utilities). Writes to a file journal, not to DB.

Log file: /srv/leadinc-logs/error_log.log

Module logger: leadinc-errorlog

Initialization at import: basic logging setup (see pitfalls below)

# 20 üß± Pitfalls & common errors

JWT + HTTPS: in the browser, cookies may not be saved over http ‚Üí locally set SECURE_COOKIE=false; for a production domain ‚Äî true and real HTTPS.

Self-signed certificate: some browsers/clients may block requests.

ChromaDB: client/server version mismatch breaks search.

Alembic: broken migrations ‚Üí clear alembic/versions, check alembic_version in DB, rebuild revisions.

Analytics titles cache: _titles_emb_cache.json is generated automatically.

Audio size for STT: limit duration/size (otherwise timeouts and cost growth).

CORS: add TEST_FRONTEND_ORIGIN for the test client, otherwise the browser will drop requests.

Async/Sync sessions: Celery/Alembic must use sync session. ‚Äúgreenlet/await‚Äù error = the wrong sessionmaker was used somewhere.

Separate Celery queues: ensure celery-text.service and celery-audio.service actually listen to their queues.

systemd units: start/restart backend and ChromaDB only via systemctl (otherwise you may get 2 instances and a flaky port).

SQL echo in prod: echo=True produces noisy logs and can potentially expose SQL/data.

Two DSN sources: backend builds from POSTGRES_*, Alembic ‚Äî from DATABASE_URL. Keep them consistent.

Session TTL vs JWT TTL: sessionid lives for 12h, JWT ‚Äî 7d. A user can have a valid JWT while the session has expired ‚Üí handle sessionid re-creation correctly.

# 21 üñºÔ∏è UI screenshots
<img width="2559" height="1227" alt="image" src="https://github.com/user-attachments/assets/ab0990ba-b722-4f30-b6e1-95e1bb94c66d" /> <img width="2559" height="1232" alt="image" src="https://github.com/user-attachments/assets/2ddee8fb-dce9-4394-b298-b3b22772ec9b" /> <img width="2559" height="1228" alt="image" src="https://github.com/user-attachments/assets/294e5152-a52d-4cef-81d4-29abfae4a98e" />
22 üìú License

The project is distributed under the MIT License ‚Äî everyone is permitted to use, modify and distribute the code.
The author bears no responsibility for use of the code by any parties.

**MIT License**

Copyright (c) 2025 Konstantin Dmitrievich Bloshko

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights to
use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
the Software, and to permit persons to whom the Software is furnished to do so,
subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

# 23 Contact

Email: kdmitrievich1994@gmail.com

Telegram: Konstantikii
